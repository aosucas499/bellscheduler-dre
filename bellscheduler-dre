#! /bin/bash

# Dejar al sistema docker que acceda al entorno gráfico
xhost +local:root

# Ejecutar el contenedor comprobando si ha sido creado o no

#variable nombre contenedor
container_name=bellscheduler

#variable nombre imagen
image_name=aosucas499/bellscheduler-dre:bionic

#variable carpeta configuración para compartir con el contenedor
STORAGE_FOLDER=/home/$SUDO_USER/BELLSCHEDULER
CONFIG_FOLDER=~/home/$SUDO_USER/BELLSCHEDULER-config

rm -r $STORAGE_FOLDER

if [ -d "$STORAGE_FOLDER" ]; then
    echo "Carpeta $STORAGE_FOLDER existe"
else
    echo "Creando carpeta $STORAGE_FOLDER"
    mkdir $STORAGE_FOLDER
    chown -R $SUDO_USER:$SUDO_USER $STORAGE_FOLDER
fi


#if [ -d "$CONFIG_FOLDER" ]; then
#    echo "Carpeta $CONFIG_FOLDER existe"
#else
#    echo "Creando carpeta $CONFIG_FOLDER"
#    mkdir $CONFIG_FOLDER
#fi

docker stop $container_name && docker rm $container_name

wget https://file-examples-com.github.io/uploads/2017/11/file_example_MP3_5MG.mp3
mv *.mp3 $STORAGE_FOLDER
chown -R $SUDO_USER:$SUDO_USER $STORAGE_FOLDER

# Lanzamos el contenedor creándolo si no existe.

sleep 5
if docker ps -a --format '{{.Names}}' | grep -Eq "^${container_name}\$"; then
   	docker start ${container_name}

else



docker run -it \
 --user=$(id -u $USER):$(id -g $USER) \
 -e PULSE_SERVER=unix:{$XDG_RUNTIME_DIR}/pulse/native \
 -v ${XDG_RUNTIME_DIR}/pulse/native:${XDG_RUNTIME_DIR}/pulse/native:Z \
 -v $STORAGE_FOLDER:/home/$USER \
 --net=host -v /tmp/.X11-unix:/tmp/.X11-unix \
 --device /dev/snd \
 -e DISPLAY=unix$DISPLAY \
 --volume="/etc/group:/etc/group:ro" \
 --volume="/etc/passwd:/etc/passwd:ro" --volume="/etc/shadow:/etc/shadow:ro" \
 --name ${container_name} ${image_name} 

#docker run -it --user=$(id -u $USER):$(id -g $USER) \
#--volume=$XDG_RUNTIME_DIR/pulse:$XDG_RUNTIME_DIR/pulse \
# -e DISPLAY="$DISPLAY" --env DBUS_SESSION_BUS_ADDRESS="$DBUS_SESSION_BUS_ADDRESS" \
# --volume="$STORAGE_FOLDER:/home/root:rw" --volume="/etc/group:/etc/group:ro" \
# --volume="/etc/passwd:/etc/passwd:ro" --volume="/etc/shadow:/etc/shadow:ro" \
# --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" -v /dev/snd:/dev/snd -v /etc/machine-id:/etc/machine-id -v /dev/shm:/dev/shm -e PULSE_SERVER=unix:$XDG_RUNTIME_DIR/pulse/native \
#--name  ${container_name} ${image_name} 

fi


